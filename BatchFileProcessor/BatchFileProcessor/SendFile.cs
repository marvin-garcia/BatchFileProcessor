using System;
using System.IO;
using System.Threading.Tasks;
using Azure.Storage.Blobs;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;

namespace BatchFileProcessor
{
    public static class SendFile
    {
        private static int _threshold = Convert.ToInt32(Environment.GetEnvironmentVariable("SendFileProbability"));
        private static string _connectionString = Environment.GetEnvironmentVariable("AzureWebJobsStorage");
        private static string _containerName = Environment.GetEnvironmentVariable("ContainerName");

        [FunctionName("SendFile")]
        public static async Task Run(
            [TimerTrigger("*/5 * * * * *")] TimerInfo myTimer,
            ILogger log)
        {
            try
            {
                log.LogInformation($"SendFile function executed at: {DateTime.Now}");
                Random random = new Random();
                int num = random.Next(100);

                if (num <= _threshold)
                {
                    // Create a BlobServiceClient object which will be used to create a container client
                    BlobServiceClient blobServiceClient = new BlobServiceClient(_connectionString);

                    // Create container client object
                    BlobContainerClient containerClient = blobServiceClient.GetBlobContainerClient(_containerName);

                    var body = new
                    {
                        Timestamp = DateTime.UtcNow.ToString(),
                        Message = "Autogenerated message through SendFile function",
                        Threshold = _threshold,
                        Value = num,
                    };

                    // Create a local file in the ./ directory for uploading and downloading
                    string localPath = Path.GetTempPath();
                    string fileName = $"{DateTime.UtcNow.ToString("yyMMddHHmmss")}-{Guid.NewGuid().ToString()}.json";
                    string localFilePath = Path.Combine(localPath, fileName);

                    // Write text to the file
                    await File.WriteAllTextAsync(localFilePath, JsonConvert.SerializeObject(body));

                    // Get a reference to a blob
                    BlobClient blobClient = containerClient.GetBlobClient(fileName);

                    log.LogInformation("Uploading to Blob storage as blob:\n\t {0}\n", blobClient.Uri);

                    // Open the file and upload its data
                    using FileStream uploadFileStream = File.OpenRead(localFilePath);
                    await blobClient.UploadAsync(uploadFileStream, true);
                    uploadFileStream.Close();
                }
            }
            catch (Exception e)
            {
                log.LogError($"SendFile failed with the exception {e}");
                throw e;
            }
        }
    }
}